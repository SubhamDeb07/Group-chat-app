<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShutApp</title>
</head>
<body>
    <form onsubmit="Send(event)" class="style-form" id ="chat-form" action="POST">
        <input type="text" name="message" placeholder="Type something ...." autocomplete="off">
        <input type="submit" value="send" >
    </form>
    <div class="chat-container-div">  
        <div class="msg-div">
        </div>
    </div>
    
</body>
</html>
<ul id="Chats"></ul>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.2.2/axios.min.js"></script>
<script>
    function Send(event){

        event.preventDefault();
        const message = event.target.message.value;

        const obj = {
            message
        }
        const token = localStorage.getItem('token');
       
         axios.post("http://localhost:3000/users/addChats", obj, {headers:{"Authorization" : token}})
        .then((response)=>{
            console.log(response);
            if(response.status === 200){
                        console.log(response.data);
                        
                        event.target.message.value ='';
                        //showOnScreen(message);
                        let name = localStorage.getItem('name');
                        saveToLocal(response.data.data, name);

                    }
        }).catch(err=>console.log(err));
   
    }


    window.addEventListener('DOMContentLoaded', async (event) =>{
        event.preventDefault();
        const token = localStorage.getItem('token');
        let lastId;

     const msg = JSON.parse(localStorage.getItem('msg')); //converts into obj

if(msg == undefined || msg.length == 0){
  lastId =0;
}
else{
  lastId = msg[msg.length-1].id;
}


        
        await axios.get(`http://localhost:3000/users/getChats?msg=${lastId}`, {headers:{"Authorization" : token}})
        .then((response)=>{
                console.log(response)
              
                var newArr = response.data.messagestosend;
                saveToLocal(newArr , response.data.username);
                if(response.status === 200){
                 showChatsOnScreen(response.data, response.data.username);
                }
            })
            .catch((err)=>{
                console.log(err)
            })
        })


    // function DisplayOnScreen(user){
    //         const parentNode = document.getElementById("Chats")
    //         const childNode = `<li id=${user.id}>${user.username}- ${user.message}</li>`
    //         parentNode.innerHTML = parentNode.innerHTML + childNode
        
    //     }

        function saveToLocal(arr,name){

let chatArray = [];
let oldMessages = JSON.parse(localStorage.getItem('msg'));

if(oldMessages == undefined || oldMessages.length ==0){
  chatArray = chatArray.concat(arr)
}
else{
  chatArray = [];
  chatArray = chatArray.concat(oldMessages,arr);
}

localStorage.setItem('msg' , JSON.stringify(chatArray))
console.log((JSON.parse(localStorage.getItem('msg'))).length)
showChatsOnScreen(name);


}
function showChatsOnScreen(name){
              console.log('inside show on scree: '+ name);
              localStorage.setItem('name', name)

              let chatArray = localStorage.getItem('msg')
              console.log(chatArray);
              let newChatArray =  JSON.parse(chatArray)
              let chatContainer = document.querySelector('.chat-container-div')


              newChatArray.forEach(chat => {
                let child = `<div class= "message-div" >
                              <div class= "resize-sent">
                                  <div class= "sent" id=${chat.id}>
                                    <p class="sent-name">${chat.username}</p>
                                    <p class="sent-msg">${chat.message}</p>
                                    
                                  
                                    </div>
                              </div>
                           </div>
                              `
                  chatContainer.innerHTML += child;
                
              });
            }

        









</script>